apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: nightmare-project
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: python:3.9-alpine
        env:
        - name: DATABASE_FILE
          value: "/data/tasks.db"
        - name: APP_NAME
          value: "MEBN Task Manager API"
        command: ["sh", "-c"]
        args:
        - |
          echo "Starting MEBN Backend with SQLite..."
          pip install flask
          
          cat > app.py << 'EOF'
          from flask import Flask, jsonify, request
          import sqlite3
          import os
          import time
          
          app = Flask(__name__)
          
          # Database file
          DB_FILE = os.getenv('DATABASE_FILE', '/data/tasks.db')
          
          def init_db():
              conn = sqlite3.connect(DB_FILE)
              c = conn.cursor()
              c.execute('''
                  CREATE TABLE IF NOT EXISTS tasks (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      title TEXT NOT NULL,
                      description TEXT,
                      status TEXT DEFAULT 'pending',
                      priority TEXT DEFAULT 'medium',
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  )
              ''')
              
              # Add sample tasks if empty
              c.execute("SELECT COUNT(*) FROM tasks")
              if c.fetchone()[0] == 0:
                  sample_tasks = [
                      ("Learn Kubernetes", "Complete homework assignment", "in progress", "high"),
                      ("Deploy MEBN Stack", "MongoDB â†’ SQLite migration", "completed", "medium"),
                      ("Fix Ingress Issues", "Traefik configuration", "pending", "high")
                  ]
                  c.executemany("INSERT INTO tasks (title, description, status, priority) VALUES (?, ?, ?, ?)", sample_tasks)
              
              conn.commit()
              conn.close()
              print(f"Database initialized at {DB_FILE}")
          
          def get_db():
              conn = sqlite3.connect(DB_FILE)
              conn.row_factory = sqlite3.Row
              return conn
          
          @app.route('/')
          def index():
              return jsonify({
                  "app": "MEBN Task Manager API",
                  "status": "running",
                  "database": "sqlite",
                  "endpoints": {
                      "health": "/health",
                      "api_health": "/api/health",
                      "tasks": "/api/tasks"
                  }
              })
          
          @app.route('/health')
          def health():
              try:
                  conn = get_db()
                  conn.execute("SELECT 1")
                  conn.close()
                  return "OK", 200
              except Exception as e:
                  return f"Database error: {str(e)}", 500
          
          @app.route('/api/health')
          def api_health():
              try:
                  conn = get_db()
                  conn.execute("SELECT 1")
                  conn.close()
                  db_status = "connected"
              except:
                  db_status = "disconnected"
              
              return jsonify({
                  "status": "healthy",
                  "service": "task-manager-backend",
                  "database": "sqlite",
                  "database_status": db_status,
                  "timestamp": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime()),
                  "kubernetes": True
              })
          
          @app.route('/api/tasks', methods=['GET'])
          def get_tasks():
              conn = get_db()
              c = conn.cursor()
              c.execute("SELECT * FROM tasks ORDER BY created_at DESC")
              rows = c.fetchall()
              conn.close()
              
              tasks = []
              for row in rows:
                  tasks.append({
                      "_id": str(row['id']),
                      "title": row['title'],
                      "description": row['description'] or "",
                      "status": row['status'] or "pending",
                      "priority": row['priority'] or "medium",
                      "createdAt": row['created_at']
                  })
              
              return jsonify(tasks)
          
          @app.route('/api/tasks', methods=['POST'])
          def create_task():
              data = request.get_json()
              if not data or 'title' not in data:
                  return jsonify({"error": "Title is required"}), 400
              
              title = data['title']
              description = data.get('description', '')
              status = data.get('status', 'pending')
              priority = data.get('priority', 'medium')
              
              conn = get_db()
              c = conn.cursor()
              c.execute(
                  "INSERT INTO tasks (title, description, status, priority) VALUES (?, ?, ?, ?)",
                  (title, description, status, priority)
              )
              conn.commit()
              task_id = c.lastrowid
              conn.close()
              
              return jsonify({
                  "_id": str(task_id),
                  "title": title,
                  "description": description,
                  "status": status,
                  "priority": priority,
                  "createdAt": time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime())
              }), 201
          
          @app.route('/api/tasks/<task_id>', methods=['DELETE'])
          def delete_task(task_id):
              conn = get_db()
              c = conn.cursor()
              c.execute("DELETE FROM tasks WHERE id = ?", (task_id,))
              deleted = c.rowcount > 0
              conn.commit()
              conn.close()
              
              if deleted:
                  return jsonify({"message": "Task deleted successfully"})
              else:
                  return jsonify({"error": "Task not found"}), 404
          
          if __name__ == '__main__':
              print("Initializing database...")
              init_db()
              print("Starting Flask server on 0.0.0.0:5000")
              app.run(host='0.0.0.0', port=5000, debug=False)
          EOF
          
          python app.py
        ports:
        - containerPort: 5000
        volumeMounts:
        - name: database-storage
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: database-storage
        emptyDir: {}