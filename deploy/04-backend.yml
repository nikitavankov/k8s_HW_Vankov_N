apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: nightmare-project
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: python:3.9-alpine
        command: ["sh", "-c"]
        args:
        - |
          echo "Starting Task Manager Backend (Python)..."
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Flask
          pip install flask flask-cors
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€
          cat > app.py << 'EOF2'
          from flask import Flask, jsonify, request
          from flask_cors import CORS
          import time
          import json
          
          app = Flask(__name__)
          CORS(app)  # Enable CORS for all routes
          
          # In-memory storage
          tasks = [
              {
                  "_id": "1",
                  "title": "Deploy to Kubernetes",
                  "description": "Deploy MERN stack application",
                  "status": "completed",
                  "priority": "high",
                  "createdAt": time.time() - 86400
              },
              {
                  "_id": "2",
                  "title": "Configure Ingress",
                  "description": "Set up Traefik ingress controller",
                  "status": "in-progress",
                  "priority": "medium",
                  "createdAt": time.time() - 43200
              },
              {
                  "_id": "3",
                  "title": "Test Application",
                  "description": "Test all API endpoints and UI",
                  "status": "pending",
                  "priority": "low",
                  "createdAt": time.time()
              }
          ]
          next_id = 4
          
          @app.route('/api/health', methods=['GET'])
          def health_check():
              return jsonify({
                  "status": "healthy",
                  "service": "task-manager-backend",
                  "database": "connected",
                  "timestamp": time.time(),
                  "kubernetes": True,
                  "version": "1.0.0",
                  "language": "Python"
              })
          
          @app.route('/api/tasks', methods=['GET'])
          def get_tasks():
              return jsonify(tasks)
          
          @app.route('/api/tasks', methods=['POST'])
          def create_task():
              global next_id
              data = request.json
              
              new_task = {
                  "_id": str(next_id),
                  "title": data.get('title', 'New Task'),
                  "description": data.get('description', ''),
                  "status": data.get('status', 'pending'),
                  "priority": data.get('priority', 'medium'),
                  "createdAt": time.time()
              }
              
              tasks.append(new_task)
              next_id += 1
              
              return jsonify(new_task), 201
          
          @app.route('/api/tasks/<task_id>', methods=['DELETE'])
          def delete_task(task_id):
              global tasks
              tasks = [task for task in tasks if task['_id'] != task_id]
              return jsonify({"message": "Task deleted successfully"})
          
          @app.route('/api/stats', methods=['GET'])
          def get_stats():
              stats = {
                  "total": len(tasks),
                  "by_status": {},
                  "by_priority": {}
              }
              
              for task in tasks:
                  stats["by_status"][task["status"]] = stats["by_status"].get(task["status"], 0) + 1
                  stats["by_priority"][task["priority"]] = stats["by_priority"].get(task["priority"], 0) + 1
              
              return jsonify(stats)
          
          @app.route('/')
          def index():
              return jsonify({
                  "message": "ðŸš€ Task Manager Backend API",
                  "version": "1.0.0",
                  "endpoints": {
                      "GET /api/health": "Health check",
                      "GET /api/tasks": "Get all tasks",
                      "POST /api/tasks": "Create new task",
                      "DELETE /api/tasks/:id": "Delete task",
                      "GET /api/stats": "Get statistics"
                  },
                  "kubernetes": {
                      "namespace": "nightmare-project",
                      "status": "running"
                  }
              })
          
          if __name__ == '__main__':
              print("Starting Task Manager Backend on port 5000...")
              print("Health endpoint: http://0.0.0.0:5000/api/health")
              print("Ready to accept connections!")
              app.run(host='0.0.0.0', port=5000, debug=False)
          EOF2
          
          python app.py
        ports:
        - containerPort: 5000
        env:
        - name: PORT
          value: "5000"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: nightmare-project
spec:
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000